CREATE PROCEDURE ExportUserAuditLogs
AS
BEGIN
    DECLARE @FilePath NVARCHAR(255) = 'C:\Path\To\Your\Folder\UserAuditLogs.csv';
    
    -- SQL query to select user audit logs
    DECLARE @SQL NVARCHAR(MAX) = '
    SELECT 
        C.name AS UserName,
        C.email AS UserEmail,
        (SELECT TOP 1 D.name 
         FROM Roles D
         JOIN UserRolewebsiteGroupMappings E ON D.Id = E.RoleID 
         WHERE C.Id = E.UserId) AS Role,
        B.Name AS ActionName,
        B.value AS ActionValue,
        B.CreatedAt AS ActionCreatedAt
    FROM 
        Useraction A
    JOIN 
        Useractionparameters B ON A.Id = B.userAction_Id
    JOIN 
        users C ON A.userId = C.Id';
    
    -- Export query result to CSV using bcp
    DECLARE @BCPCommand NVARCHAR(1000);
    SET @BCPCommand = 'bcp "' + @SQL + '" queryout "' + @FilePath + '" -c -t, -T -S ' + @@SERVERNAME;

    -- Execute the bcp command
    EXEC master..xp_cmdshell @BCPCommand;
END
