# Define API endpoints and credentials
$logApiUrl = "https://www.netsparkercloud.com/api/1.0/auditlogs/list"
$userApiUrl = "https://www.netsparkercloud.com/api/1.0/users/list"
$roleApiUrl = "https://www.netsparkercloud.com/api/1.0/roles/list"
$userId = "YOUR_USER_ID"
$apiToken = "YOUR_API_TOKEN"

# Encode credentials in Base64
$authHeader = [Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes("$userId:$apiToken"))

# Function to get users
function Get-Users {
    $response = Invoke-RestMethod -Uri $userApiUrl -Headers @{Authorization = "Basic $authHeader"} -Method Get
    return $response
}

# Function to get roles
function Get-Roles {
    $response = Invoke-RestMethod -Uri $roleApiUrl -Headers @{Authorization = "Basic $authHeader"} -Method Get
    return $response
}

# Function to get audit logs
function Get-AuditLogs {
    $response = Invoke-RestMethod -Uri $logApiUrl -Headers @{Authorization = "Basic $authHeader"} -Method Get
    return $response
}

# Fetch audit logs, users, and roles
$users = Get-Users
$roles = Get-Roles
$auditLogs = Get-AuditLogs

# Combine data
$combinedData = @()
foreach ($log in $auditLogs) {
    $user = $users | Where-Object { $_.Id -eq $log.UserId }
    $role = $roles | Where-Object { $_.UserId -eq $log.UserId }

    $combinedData += [pscustomobject]@{
        UserName   = $user.name
        UserEmail  = $user.email
        Role       = $role.name
        Action     = $log.Name
        ActionValue = $log.value
        CreatedAt  = $log.CreatedAt
    }
}

# Export combined data to CSV
$csvPath = "C:\path\to\auditlogs.csv"
$combinedData | Export-Csv -Path $csvPath -NoTypeInformation

# Schedule the script to run every hour
$trigger = New-JobTrigger -Once -At (Get-Date).AddHours(1) -RepetitionInterval (New-TimeSpan -Hours 1) -RepeatIndefinitely
Register-ScheduledJob -ScriptBlock {
    # Your script logic here (same as above)
} -Trigger $trigger -Name "AuditLogFetchJob"

Write-Host "Audit logs saved to $csvPath"
