# Define parameters
$serverName = "YourServerName"          # SQL Server Name
$databaseName = "netsparker"            # Database Name
$filePath = "C:\Path\To\Your\Folder\UserLogs.csv"  # Update this path as needed

# Construct the SQL query
$sqlQuery = @"
SELECT 
    C.name AS UserName,
    C.email AS UserEmail,
    (SELECT TOP 1 D.name 
     FROM Roles D
     JOIN UserRolewebsiteGroupMappings E ON D.Id = E.RoleID 
     WHERE C.Id = E.UserId) AS Role,
    B.Name AS ActionName,
    B.value AS ActionValue,
    B.CreatedAt AS ActionCreatedAt
FROM 
    Useractions A
JOIN 
    Useractionparameters B ON A.Id = B.userAction_Id
JOIN 
    users C ON A.userId = C.Id;
"@

# Construct the bcp command
$bcpCommand = "bcp `"$sqlQuery`" queryout `"$filePath`" -c -t, -T -S $serverName"

# Execute the bcp command
Invoke-Expression $bcpCommand

# Optional: Output success message
Write-Host "Export completed successfully to $filePath"


Set-ExecutionPolicy RemoteSigned -Scope CurrentUser

